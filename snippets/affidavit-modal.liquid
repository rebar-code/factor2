{% comment %}
  Affidavit Modal Form
  Renders the affidavit form modal that appears when customer needs to sign affidavit
{% endcomment %}

<div id="affidavit-modal" class="affidavit-modal" style="display: none;">
  <div class="affidavit-modal__overlay" onclick="closeAffidavitModal()"></div>
  <div class="affidavit-modal__content">
    <button class="affidavit-modal__close" onclick="closeAffidavitModal()">&times;</button>

    <h1>Factor II, Inc. Affidavit of Intended Use</h1>
    <p class="affidavit-modal__note">
      ALL FIELDS WITH * MUST BE FILLED OUT!!! THE AFFIDAVIT MUST BE FILLED OUT COMPLETELY!!!!<br>
      THIS FORM SHOULD NOT BE ALTERED IN ANY MANNER.
    </p>

    <form id="affidavitForm" class="affidavit-form">
      <input type="hidden" id="customerId" value="{{ customer.id | split: '/' | last }}">
      <input type="hidden" id="productCodes" value="">

      <div class="affidavit-form__section">
        <h2>Contact Information</h2>

        <label class="required">Name: INDIVIDUAL Responsible for product</label>
        <input
          type="text"
          id="name"
          name="name"
          required
          value="{% if customer %}{{ customer.first_name }} {{ customer.last_name }}{% endif %}"
        >

        <label class="required">Company or Organization</label>
        <input type="text" id="company" name="company" required>

        <label class="required">Address 1</label>
        <input
          type="text"
          id="address1"
          name="address1"
          required
          value="{% if customer.default_address %}{{ customer.default_address.address1 }}{% endif %}"
        >

        <label>Address 2</label>
        <input
          type="text"
          id="address2"
          name="address2"
          value="{% if customer.default_address %}{{ customer.default_address.address2 }}{% endif %}"
        >

        <label class="required">City</label>
        <input
          type="text"
          id="city"
          name="city"
          required
          value="{% if customer.default_address %}{{ customer.default_address.city }}{% endif %}"
        >

        <label class="required">State</label>
        <input
          type="text"
          id="state"
          name="state"
          required
          value="{% if customer.default_address %}{{ customer.default_address.province }}{% endif %}"
        >

        <label class="required">Postal Code</label>
        <input
          type="text"
          id="postal"
          name="postal"
          required
          value="{% if customer.default_address %}{{ customer.default_address.zip }}{% endif %}"
        >

        <label class="required">Country</label>
        <input
          type="text"
          id="country"
          name="country"
          required
          value="{% if customer.default_address %}{{ customer.default_address.country }}{% endif %}"
        >

        <label class="required">Telephone</label>
        <input
          type="tel"
          id="telephone"
          name="telephone"
          required
          value="{% if customer.default_address %}{{ customer.default_address.phone }}{% endif %}"
        >

        <label class="required">Email</label>
        <input type="email" id="email" name="email" required value="{% if customer %}{{ customer.email }}{% endif %}">
      </div>

      <div class="affidavit-form__section">
        <p style="font-weight: bold; color: red; margin: 15px 0;">***ALL QUESTIONS MUST BE ANSWERED ***</p>

        <label class="required">Factor II Product Code(s): (Aforementioned product)</label>
        <input type="text" id="productCodesInput" name="productCodes" required placeholder="e.g., A-100, B-200">

        <label class="required">Is the final product to be in contact with tissue externally?</label>
        <select id="contactTissue" name="contactTissue" required>
          <option value="">Select...</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>

        <label class="required">How and in what form (Cured or Uncured)?</label>
        <textarea id="howForm" name="howForm" rows="3" required></textarea>

        <label class="required">Will the final product be implanted?</label>
        <select id="implanted" name="implanted" required onchange="toggleImplantFields()">
          <option value="">Select...</option>
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>

        <div id="implantFields" class="hidden">
          <p class="note" style="margin: 10px 0;">
            If YES, please attach additional information/protocol, along with this document.<br>
            We may contact you for further information.
          </p>
          <label class="required">How long will the product be implanted? (Days)</label>
          <input type="number" id="implantDays" name="implantDays" min="0" required>

          <label>Attach additional information/protocol (PDF, DOC, etc.)</label>
          <input type="file" id="attachment" name="attachment" accept=".pdf,.doc,.docx,.jpg,.png" multiple>
        </div>

        <label class="required"
          >Please briefly describe below (or on separate page if necessary) the protocol for your application of the
          aforementioned product(s).</label
        >
        <textarea id="protocol" name="protocol" rows="6" required></textarea>
      </div>

      <div class="affidavit-form__section">
        <label class="required">Print Name: , being duly sworn, depose and say as follows:</label>
        <input
          type="text"
          id="printName"
          name="printName"
          required
          value="{% if customer %}{{ customer.first_name }} {{ customer.last_name }}{% endif %}"
        >

        <p style="margin: 15px 0; line-height: 1.6;">
          I certify that I will not use, either in its pure state or as a component of some other material, any of the
          aforementioned product(s) hereafter received by me from Factor II, Inc. for injection or implantation into any
          areas of the human body in a cured or uncured state, or onto any areas of the human body in a cured or uncured
          state for an un-approved application, nor will I supply the aforementioned product(s) to others for such
          purposes. Factor II cannot advise if the product you are using will be suitable for your application. All
          companies and/or individuals are responsible for final testing of their products to determine their safety and
          use.
        </p>

        <label class="required">Signature:</label>
        <canvas id="signature-pad" width="600" height="200"></canvas>
        <button type="button" id="clearSig" onclick="clearSignature()">Clear Signature</button>

        <label class="required">Title:</label>
        <input type="text" id="title" name="title" required>

        <label class="required">Date:</label>
        <input type="date" id="date" name="date" required value="{{ 'now' | date: '%Y-%m-%d' }}">
      </div>

      <div class="affidavit-form__actions">
        <button type="button" onclick="closeAffidavitModal()">Cancel</button>
        <button type="submit" id="submitBtn">Submit Affidavit</button>
      </div>
    </form>
  </div>
</div>

<style>
  .affidavit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
  }

  .affidavit-modal__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
  }

  .affidavit-modal__content {
    position: relative;
    max-width: 800px;
    max-height: 90vh;
    margin: 5vh auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    overflow-y: auto;
    z-index: 10001;
  }

  .affidavit-modal__close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 30px;
    cursor: pointer;
    color: #666;
  }

  .affidavit-modal__note {
    font-style: italic;
    color: #555;
    margin-bottom: 20px;
  }

  .affidavit-form__section {
    margin-bottom: 30px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  .affidavit-form label {
    display: block;
    margin: 15px 0 5px;
    font-weight: bold;
  }

  .affidavit-form label.required::after {
    content: ' *';
    color: red;
  }

  .affidavit-form input,
  .affidavit-form select,
  .affidavit-form textarea {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  #signature-pad {
    border: 2px solid #000;
    background: #fff;
    width: 100%;
    height: 200px;
    cursor: crosshair;
  }

  .affidavit-form__actions {
    margin-top: 30px;
    text-align: right;
  }

  .affidavit-form__actions button {
    padding: 10px 20px;
    margin-left: 10px;
    cursor: pointer;
    border: none;
    border-radius: 4px;
  }

  .affidavit-form__actions button[type='submit'] {
    background: #007bff;
    color: white;
  }

  .hidden {
    display: none;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
<script>
  let signaturePad;

  function initSignaturePad() {
    const canvas = document.getElementById('signature-pad');
    if (!canvas) return;

    signaturePad = new SignaturePad(canvas, {
      backgroundColor: 'rgb(255,255,255)',
      penColor: 'rgb(0,0,0)',
    });
  }

  function clearSignature() {
    if (signaturePad) {
      signaturePad.clear();
    }
  }

  function toggleImplantFields() {
    const implanted = document.getElementById('implanted').value;
    const implantFields = document.getElementById('implantFields');
    const implantDaysInput = document.getElementById('implantDays');

    if (implanted === 'Yes') {
      implantFields.classList.remove('hidden');
      implantDaysInput.required = true;
    } else {
      implantFields.classList.add('hidden');
      implantDaysInput.required = false;
      implantDaysInput.value = '';
    }
  }

  function openAffidavitModal(productId, productCodes) {
    document.getElementById('productCodes').value = productCodes;
    document.getElementById('productCodesInput').value = productCodes;
    document.getElementById('affidavit-modal').style.display = 'block';
    initSignaturePad();
  }

  function closeAffidavitModal() {
    document.getElementById('affidavit-modal').style.display = 'none';
    if (signaturePad) {
      signaturePad.clear();
    }
  }

  // Listen for custom event
  document.addEventListener('openAffidavitModal', function (event) {
    openAffidavitModal(event.detail.productId, event.detail.productCodes);
  });

  // Handle form submission
  document.getElementById('affidavitForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();

    // Validate signature
    if (!signaturePad || signaturePad.isEmpty()) {
      alert('Please provide a signature.');
      return;
    }

    // Check if implanted is Yes and implantDays is required
    const implanted = document.getElementById('implanted').value;
    if (implanted === 'Yes') {
      const implantDays = document.getElementById('implantDays').value;
      if (!implantDays || implantDays === '') {
        alert('Please fill out "How long will the product be implanted?" field.');
        return;
      }
    }

    // Get signature as base64
    const signatureData = signaturePad.toDataURL('image/png');

    // Prepare form data
    const formData = new FormData();
    formData.append('customerId', document.getElementById('customerId').value);
    formData.append('name', document.getElementById('name').value);
    formData.append('company', document.getElementById('company').value);
    formData.append('address1', document.getElementById('address1').value);
    formData.append('address2', document.getElementById('address2').value);
    formData.append('city', document.getElementById('city').value);
    formData.append('state', document.getElementById('state').value);
    formData.append('postal', document.getElementById('postal').value);
    formData.append('country', document.getElementById('country').value);
    formData.append('telephone', document.getElementById('telephone').value);
    formData.append('email', document.getElementById('email').value);
    formData.append('productCodes', document.getElementById('productCodesInput').value);
    formData.append('contactTissue', document.getElementById('contactTissue').value);
    formData.append('howForm', document.getElementById('howForm').value);
    formData.append('implanted', document.getElementById('implanted').value);
    if (implanted === 'Yes') {
      formData.append('implantDays', document.getElementById('implantDays').value);
    }
    formData.append('protocol', document.getElementById('protocol').value);
    formData.append('printName', document.getElementById('printName').value);
    formData.append('signature', signatureData);
    formData.append('title', document.getElementById('title').value);
    formData.append('date', document.getElementById('date').value);

    // Handle attachments
    const attachmentInput = document.getElementById('attachment');
    const attachments = attachmentInput.files;
    formData.append('attachmentCount', attachments.length);
    for (let i = 0; i < attachments.length; i++) {
      formData.append(`attachment_${i}`, attachments[i]);
    }

    // Submit to API
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    // Try app proxy URL first, fallback to full app URL
    const appProxyUrl = '/apps/affidavit/api/affidavits/submit';
    // Get app URL from Liquid or use default
    const fullAppUrl =
      '{{ shop.metafields.app.affidavit_app_url.value | default: "https://factor2.vercel.app" }}/api/affidavits/submit';

    let response;
    let result;
    let lastError;

    try {
      // Try app proxy first (if configured in Shopify)
      try {
        response = await fetch(appProxyUrl, {
          method: 'POST',
          body: formData,
        });

        // If 404 or network error, try full app URL
        if (response.status === 404 || !response.ok) {
          throw new Error(`App proxy failed: ${response.status}`);
        }
      } catch (proxyError) {
        console.log('App proxy failed, trying full app URL...', proxyError);
        // Try full app URL
        try {
          response = await fetch(fullAppUrl, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API error: ${response.status} - ${errorText}`);
          }
        } catch (fullUrlError) {
          console.error('Full URL also failed:', fullUrlError);
          throw new Error(
            `Failed to submit affidavit. Please check that the app is deployed and accessible. Error: ${fullUrlError.message}`
          );
        }
      }

      result = await response.json();

      if (response.ok && result.success) {
        alert('Affidavit submitted successfully! Your submission is pending review.');
        closeAffidavitModal();
        // Reload page to update button state
        window.location.reload();
      } else {
        alert('Error submitting affidavit: ' + (result.error || 'Unknown error'));
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Affidavit';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error submitting affidavit. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Affidavit';
    }
  });

  // Initialize signature pad on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSignaturePad);
  } else {
    initSignaturePad();
  }
</script>
